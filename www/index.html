<!doctype html>
<html>
  <head>
    <title>crisp</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css"
    />
  </head>
  <body>
    <p class="bold-text">
      <a class="no-decoration" href="/">crisp üçÇ</a>
    </p>
    <p style="margin-top: -0.5em">
      a web playground for the crisp programming language
    </p>

    <div class="editor-container">
      <textarea id="inputArea"></textarea>
      <div class="button-container">
        <button onclick="evaluateCode()">Run</button>
      </div>
    </div>

    <pre id="result"></pre>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/commonlisp/commonlisp.min.js"></script>

    <script>
      var Module = {
        onRuntimeInitialized: () => console.log('WebAssembly loaded'),
      };

      const editor = CodeMirror.fromTextArea(
        document.getElementById('inputArea'),
        {
          lineNumbers: true,
          tabSize: 2,
          theme: 'default',
          mode: 'commonlisp',
        }
      );

      editor.save();

      const evaluateCode = () => {
        const resultElement = document.getElementById('result');

        if (typeof Module._run === 'function') {
          const str = editor.getValue();

          const inputBuffer = Module._malloc(str.length + 1);

          Module.stringToUTF8(str, inputBuffer, str.length + 1);

          const resultPointer = Module.ccall(
            'run',
            'number',
            ['number'],
            [inputBuffer]
          );

          const resultString = Module.UTF8ToString(resultPointer);

          Module._free(inputBuffer);

          if (resultString.trim() !== '') {
            resultElement.style.display = 'block';
            resultElement.innerText += `> ${resultString}\n`;
            resultElement.scrollTop = resultElement.scrollHeight;
          }
        } else {
          console.log(
            "WebAssembly module has not loaded yet, or 'run' function is not available."
          );
        }
      };
    </script>

    <script async type="text/javascript" src="index.js"></script>
  </body>
</html>
